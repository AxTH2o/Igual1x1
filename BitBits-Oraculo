// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";

interface AggregatorV3Interface {
    function decimals() external view returns (uint8);
    function latestRoundData() external view returns (uint80 roundId, int256 answer, uint256 startedAt, uint256 updatedAt, uint80 answeredInRound);
}

contract BitBits is ERC20, Ownable {
    // Chainlink oracles on Sepolia testnet
    address public constant ETH_USD_ORACLE = 0x694AA1769357215DE4FAC081bf1f309aDC325306; // ETH/USD
    address public constant BTC_USD_ORACLE = 0x1b44F3514812d835EB1BDB0acB33d3fA3351Ee43; // BTC/USD (Sepolia)

    uint8 public constant BTC_DECIMALS = 8; // Chainlink price decimals
    uint8 public constant TOKEN_DECIMALS = 18;
    uint256 public constant INITIAL_SUPPLY = 70_000_000 * 10**TOKEN_DECIMALS;

    error InvalidAmount(uint256 amount);
    error OracleError(int256 price);

    constructor() ERC20("BitBits", "BitBtc") Ownable(msg.sender) {
        _mint(msg.sender, INITIAL_SUPPLY);
    }

    function mintBacked() external payable onlyOwner {
        if (msg.value == 0) revert InvalidAmount(0);

        // Get ETH/USD price
        (, int256 ethPrice, , , ) = AggregatorV3Interface(ETH_USD_ORACLE).latestRoundData();
        if (ethPrice <= 0) revert OracleError(ethPrice);

        // Get BTC/USD price
        (, int256 btcPrice, , , ) = AggregatorV3Interface(BTC_USD_ORACLE).latestRoundData();
        if (btcPrice <= 0) revert OracleError(btcPrice);

        // Calculate USD value of deposited ETH
        uint256 ethUsdValue = (uint256(ethPrice) * msg.value * (10 ** TOKEN_DECIMALS)) / (10 ** BTC_DECIMALS);

        // Calculate BitBtc to mint (1 BitBtc = 1 USD / BTC price)
        uint256 amountToMint = (ethUsdValue * (10 ** TOKEN_DECIMALS)) / (uint256(btcPrice) * (10 ** (TOKEN_DECIMALS - BTC_DECIMALS)));
        if (amountToMint == 0) revert InvalidAmount(0);

        _mint(msg.sender, amountToMint);
    }

    function getBtcPrice() public view returns (int256) {
        (, int256 price, , , ) = AggregatorV3Interface(BTC_USD_ORACLE).latestRoundData();
        return price;
    }

    function mint(address to, uint256 amount) external onlyOwner {
        if (amount == 0) revert InvalidAmount(0);
        _mint(to, amount);
    }
}
